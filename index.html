<!DOCTYPE html>
<html>
  <head>
    <title>Tremor Tracker - History + Latest</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getDatabase,
        ref,
        onValue,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

      // ðŸ”¹ Config Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyCUpSrDPRTvLOot4e4QboWgdJLj_PQByn8",
        authDomain: "parkinson-11301.firebaseapp.com",
        databaseURL: "https://parkinson-11301-default-rtdb.firebaseio.com",
        projectId: "parkinson-11301",
        storageBucket: "parkinson-11301.appspot.com",
        messagingSenderId: "779006164225",
        appId: "779006164225",
      };

      // Inisialisasi Firebase
      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);

      // ðŸ”¹ Path ke history dan latest
      const historyRef = ref(database, "tremor_data/esp32_tremor_01/history");
      const latestRef = ref(database, "tremor_data/esp32_tremor_01/latest");

      let ctx = null;
      let tremorChart = null;

      window.onload = function () {
        ctx = document.getElementById("tremorChart").getContext("2d");

        // Buat chart awal
        tremorChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "Tremor Magnitude",
                data: [],
                borderColor: "red",
                borderWidth: 2,
                fill: false,
              },
            ],
          },
          options: {
            responsive: true,
            animation: false,
            scales: {
              x: { display: true, title: { display: true, text: "Time" } },
              y: {
                display: true,
                title: { display: true, text: "Magnitude (g)" },
              },
            },
          },
        });

        // ðŸ”¹ Ambil history (gelombang awal)
        onValue(historyRef, (snapshot) => {
          const data = snapshot.val();
          if (data) {
            tremorChart.data.labels = [];
            tremorChart.data.datasets[0].data = [];

            const entries = Object.values(data).sort(
              (a, b) => a.timestamp_ms - b.timestamp_ms
            );
            entries.forEach((entry) => {
              if (
                entry.magnitude !== undefined &&
                entry.timestamp_ms !== undefined
              ) {
                const timeLabel = new Date(
                  entry.timestamp_ms
                ).toLocaleTimeString();
                tremorChart.data.labels.push(timeLabel);
                tremorChart.data.datasets[0].data.push(entry.magnitude);
              }
            });

            //ini yang sy tamabh
            const MAX_POINTS = 50; // tampilkan hanya 50 titik terakhir
          if (tremorChart.data.labels.length > MAX_POINTS) {
              tremorChart.data.labels.shift(); // hapus label lama
              tremorChart.data.datasets[0].data.shift(); // hapus data lama
              }


            
            tremorChart.update();
          }
        });

        // ðŸ”¹ Update chart realtime dari latest
        onValue(latestRef, (snapshot) => {
          const data = snapshot.val();
          if (
            data &&
            data.magnitude !== undefined &&
            data.timestamp_ms !== undefined
          ) {
            const timeLabel = new Date(data.timestamp_ms).toLocaleTimeString();

            // simpan hanya 50 data terakhir supaya chart tidak terlalu panjang
            if (tremorChart.data.labels.length >= 50) {
              tremorChart.data.labels.shift();
              tremorChart.data.datasets[0].data.shift();
            }

            tremorChart.data.labels.push(timeLabel);
            tremorChart.data.datasets[0].data.push(data.magnitude);
            tremorChart.update();
          }
        });
      };
    </script>
  </head>
  <body>
    <h2>Tremor Magnitude Realtime + History</h2>
    <canvas id="tremorChart" width="600" height="400"></canvas>
  </body>
</html>

